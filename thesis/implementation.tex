\section{Analysis specification}
\label{sec:AnalysisSpec}
specifica dell'analisi

\subsection{Abstract succinct}
\[
\begin{array}{llcl}
\mathit{Abstract\ cache} & \Cat & : & \labs \rightarrow \absvalues \\
\mathit{Abstract\ variable\ environment} & \Env & : & \vars \rightarrow \absvalues \\
\mathit{Abstract\ memory} & \absmem & : & \labs \times \perms \rightarrow \absvalues \\
\mathit{Abstract\ permission\ cache} & \Pat & : & \labs \rightarrow \perms \\
\end{array}
\]
\begin{comment}
\begin{tabular}{l l l l}
{[\textit{PV-Name}]}&\multicolumn{3}{l}{$\aenvs \modelrho n : \vat$ iff $n \in \vat$} \\
{[\textit{PV-Var}]}&\multicolumn{3}{l}{$\aenvs \modelrho x : \vat$ iff $\Env(x) \subseteq \vat$} \\ 
{[\textit{PV-Cons}]}&\multicolumn{3}{l}{$\aenvs \modelrho c : \vat$ iff $\{\hat{c}\} \subseteq \vat$} \\
{[\textit{PV-Ref}]}&\multicolumn{3}{l}{$\aenvs \modelrho \ell : \vat$ iff $\ell \in \vat$} \\
{[\textit{PV-Lambda}]}&\multicolumn{3}{l}{$\aenvs \modelrho \lam{x}{e} : \vat$ iff $\lambda_x^{\rho_e} \in \vat \wedge \aenvs \modelrho e : \vat'\gg \rho' $} \\
&&\multicolumn{2}{l}{$\vat' \sqsubseteq \Env(\lambda x) \wedge \rho' \sqsubseteq \rho_e $}\\
{[\textit{PV-Ref}]}&\multicolumn{3}{l}{$\aenvs \modelrho \rec{\vec{str_i : v_i}} : \vat$ iff $\{\absrec{\vec{str_i: v_i}}_{\absC,\rho}\} \sqsubseteq \hat{v}$} \\
\end{tabular}

\begin{table}[tlb]
\begin{tabular}{l l l l}
{[\textit{PE-Val}]}&\multicolumn{3}{l}{$\caest {v}$ iff}\\
&&\multicolumn{2}{l}{$\aenvs \modelrho v : \vat$} \\
{[\textit{PE-Let}]}&\multicolumn{3}{l}{$\caest {\letexpr{x}{e_1}{e_2}}$ iff}\\
&&\multicolumn{2}{l}{$\caesti {e_1} {1} \wedge \vat_1 \sqsubseteq \Env(x) \wedge \rho_1 \sqsubseteq \rho \wedge$} \\
&&\multicolumn{2}{l}{$\aenvs \modelrho e_2 : \vat_2 \gg \rho_2 \wedge \vat_2 \sqsubseteq \vat \wedge \rho_2 \sqsubseteq \rho$} \\
{[\textit{PE-App}]}&\multicolumn{3}{l}{$\caest {\appl {e_1} {e_2}}$ iff} \\
&&\multicolumn{2}{l}{$\caesti {e_1} {1} \wedge \rho_1 \sqsubseteq \rho \wedge$} \\
&&\multicolumn{2}{l}{$\caesti {e_2} {2} \wedge \rho_2 \sqsubseteq \rho \wedge$} \\
&&\multicolumn{2}{l}{$\forall \lambda x^{\rho_e} \in \vat_1 :$}\\
&&&$\vat_2 \subseteq \Env(x) \wedge$\\
&&&$\Env(\lambda x) \sqsubseteq \vat \wedge \rho_e \sqsubseteq \rho$\\ 
{[\textit{PE-Seq}]}&\multicolumn{3}{l}{$\caest {e_1; e_2} $ iff}\\
&&\multicolumn{2}{l}{$ \caesti {e_1} {1} \wedge \rho_1 \sqsubseteq \rho \wedge$}\\
&&\multicolumn{2}{l}{$ \caesti {e_2} {2} \wedge \rho_2 \sqsubseteq \rho \wedge$} \\
&&\multicolumn{2}{l}{$\vat_2 \sqsubseteq \vat$} \\
{[\textit{PE-Op}]}&\multicolumn{3}{l}{$\caest {\op (\vec{e_i})} $ iff}\\
&&\multicolumn{2}{l}{$\forall i :$}\\
&&&$\caesti {e_i} {i} \wedge \rho_i \sqsubseteq \rho \wedge$\\
&&\multicolumn{2}{l}{$\widehat{op} (\vec{\vat_i}) \sqsubseteq \vat $}\\
{[\textit{PE-Cond}]}&\multicolumn{3}{l}{$\caest {\cond {e_0} {e_1} {e_2}} $ iff}\\
&&\multicolumn{2}{l}{$\caesti {e_0} {0} \wedge \rho_0 \sqsubseteq \rho \wedge$}\\
&&\multicolumn{2}{l}{$\mathbf{\true} \in \vat_0 \Rightarrow$}\\
&&&$\caesti {e_1} {1} \wedge \vat_1 \sqsubseteq \vat \wedge \rho_1 \sqsubseteq \rho \wedge$ \\
&&\multicolumn{2}{l}{$\mathbf{\false} \in \vat_0 \Rightarrow$}\\
&&&$\caesti {e_2} {2} \wedge \vat_2 \sqsubseteq \vat \wedge \rho_2 \sqsubseteq \rho$ \\
{[\textit{PE-While}]}&\multicolumn{3}{l}{$\caest {\while {e_1} {e_2}} $ iff}\\
&&\multicolumn{2}{l}{$\caesti {e_1} {1} \wedge \rho_1 \sqsubseteq \rho \wedge$}\\
&&\multicolumn{2}{l}{$\mathbf{\true} \in \vat_1 \Rightarrow$}\\
&&&$\caesti {e_2} {2} \wedge \rho_2 \sqsubseteq \rho \wedge$\\ % opinabile rispetto a lambda js
&&\multicolumn{2}{l}{$\widehat{\false} \in \vat_1 \Rightarrow$}\\
&&&$\widehat{\undef} \sqsubseteq \vat$\\
\end{tabular}
\caption{Abstract succinct part 1.}
\label{tab:AbstSucc1}
\end{table}
\begin{table}[tlb]
\begin{tabular} {l l l l}
{[\textit{PE-GetField}]}&\multicolumn{3}{l}{$\caest {\lookup {e_1} {e_2}} $ iff}\\
&&\multicolumn{2}{l}{$ \caesti {e_1} {1} \wedge \rho_1 \sqsubseteq \rho \wedge$}\\
&&\multicolumn{2}{l}{$ \caesti {e_2} {2} \wedge \rho_2 \sqsubseteq \rho \wedge$} \\
&&\multicolumn{2}{l}{$\widehat{get} (\vat_1, \vat_2) \sqsubseteq \vat$} \\
{[\textit{PE-SetField}]}&\multicolumn{3}{l}{$\caest {\store {e_0} {e_1} {e_2}} $ iff}\\
&&\multicolumn{2}{l}{$ \caesti {e_0} {0} \wedge \rho_0 \sqsubseteq \rho \wedge$}\\
&&\multicolumn{2}{l}{$ \caesti {e_1} {1} \wedge \rho_1 \sqsubseteq \rho \wedge$} \\
&&\multicolumn{2}{l}{$ \caesti {e_2} {2} \wedge \rho_2 \sqsubseteq \rho \wedge$} \\
&&\multicolumn{2}{l}{$\widehat{set} (\vat_0, \vat_1, \vat_2) \sqsubseteq \vat$} \\
{[\textit{PE-DelField}]}&\multicolumn{3}{l}{$\caest {\delete {e_1} {e_2}} $ iff}\\
&&\multicolumn{2}{l}{$ \caesti {e_1} {1} \wedge \rho_1 \sqsubseteq \rho \wedge$}\\
&&\multicolumn{2}{l}{$ \caesti {e_2} {2} \wedge \rho_2 \sqsubseteq \rho \wedge$} \\
&&\multicolumn{2}{l}{$\widehat{del} (\vat_1, \vat_2) \sqsubseteq \vat$}\\
{[\textit{PE-Ref}]}&\multicolumn{3}{l}{$ \caest {\newref {\ell} {e}}$ iff}\\
&&\multicolumn{2}{l}{$ \caesti {e} {1} \wedge \rho_1 \sqsubseteq \rho\wedge$}\\
&&\multicolumn{2}{l}{$\vat_1 \sqsubseteq \muat(\ell, \rho_s) \wedge $} \\
&&\multicolumn{2}{l}{$\ell \in \vat$} \\
{[\textit{PE-DeRef}]}&\multicolumn{3}{l}{$\caest {\deref {e}} $ iff}\\
&&\multicolumn{2}{l}{$\caesti {e} {1} \wedge \rho_1 \sqsubseteq \rho \wedge$}\\
&&\multicolumn{2}{l}{$\forall \ell \in \vat_1 : \muat(\ell, \rho_s) \sqsubseteq \vat$ }\\
{[\textit{PE-SetRef}]}&\multicolumn{3}{l}{$\caest {\setref {e_1} {e_2}} $ iff}\\
&&\multicolumn{2}{l}{$ \caesti {e} {1} \wedge \rho_1 \sqsubseteq \rho \wedge$}\\
&&\multicolumn{2}{l}{$ \caesti {e_2} {2} \wedge \rho_2 \sqsubseteq \rho \wedge$}\\
%&&\multicolumn{2}{l}{$\rho_2 \sqsubseteq \rho \wedge$}\\
&&\multicolumn{2}{l}{$\vat_2 \sqsubseteq \vat \wedge$}\\
&&\multicolumn{2}{l}{$\forall \ell \in \vat_1: \vat_2 \sqsubseteq \muat(\ell, \rho_s)$}\\
{[\textit{PE-Send}]}&\multicolumn{3}{l}{$\caesti {\send {e_1} {e_2} {\rho}} {0} $ iff}\\
&&\multicolumn{2}{l}{$ \caesti {e} {1} \wedge \rho_1 \sqsubseteq \rho_0 \wedge$}\\
&&\multicolumn{2}{l}{$ \caesti {e} {2} \wedge \rho_2 \sqsubseteq \rho_0 \wedge$}\\
&&\multicolumn{2}{l}{$ \forall m \in \vat_1 : \forall \rho_m \sqsupseteq \rho:$}\\
&&&$\hat{\Upsilon}(m, \rho_m) = (\rho_r, \rho_e)\wedge $\\
&&&$\rho_r \sqsubseteq \rho_s \Rightarrow \rho_e \sqsubseteq \rho_0 \wedge$\\
&&&$\vat_2 \sqsubseteq \hat{\Phi}(m, \rho_m) \wedge $\\
&&&$\mathbf{unit} \in \vat $\\
{[\textit{PE-Exercise}]}&\multicolumn{3}{l}{$\caesti {\exercise {\rho}} {1} $ iff}\\
&&\multicolumn{2}{l}{$ \rho \sqsubseteq \rho_s \Rightarrow \rho \sqsubseteq \rho_1 \wedge $}\\
&&\multicolumn{2}{l}{$ \mathbf{unit} \in \vat$}\\
\end{tabular}
\caption{Abstract succinct part 2.}
\label{tab:AbstSucc2}
\end{table}
\end{comment}

\newcommand{\all}[0]{\alpha}
\subsection{Compositional Verbose}
\begin{table}
\begin{tabular}{l l l l}
{[\textit{CV-Val}]}&\multicolumn{3}{l}{$ \ccestl {v} $ iff $\{\vat\} \sqsubseteq \Cat(\all)$} \\ 
%{[\textit{CV-Var}]}&\multicolumn{3}{l}{$ \ccestl {x} $ iff $\Env(x) \sqsubseteq \Cat(\a)$} \\ 
{[\textit{CV-Lambda}]}&\multicolumn{3}{l}{$ \ccestl {\lam{x}{\lbt 0}} $ iff}\\
&&\multicolumn{2}{l}{$\{\lam{x}{\lbt 0}\} \sqsubseteq \Cat(\all) \wedge $}\\
&&\multicolumn{2}{l}{$ \ccest {\lbt 0}$}\\
%{[\textit{CV-Obj}]}&\multicolumn{3}{l}{$ \ccestl {\rec{\vec{str_i : \lbt i}}}$ iff}\\
%&&\multicolumn{2}{l}{$\forall i:$}\\
%&&&$\ccest {\lbt i} \wedge$\\
%&&&$\Pat(\ell_i) \sqsubseteq \Pat(\ell) \wedge$\\ 
%&&\multicolumn{2}{l}{$\rec{\vec{str_i : \Cat(\ell_i)}} \sqsubseteq \Cat_\ell $} \\
{[\textit{CV-Let}]}&\multicolumn{3}{l}{$ \ccestl {\letexpr{x}{\lbt 1}{{e'}^{\all'}}}$ iff}\\
&&\multicolumn{2}{l}{$ \ccest {{e'}^{\all'}} \wedge$} \\
&&\multicolumn{2}{l}{$ \Pat(\all') \sqsubseteq \Pat(\all) \wedge$}\\
&&\multicolumn{2}{l}{$ \Cat(\all') \sqsubseteq \Cat(\all) \wedge$}\\
&&\multicolumn{2}{l}{$\ccest {{e_1}^{\all_1}} \wedge$}\\
&&\multicolumn{2}{l}{ $ \Cat(\all_1) \sqsubseteq \Env(x_1) \wedge$} \\
&&\multicolumn{2}{l}{ $ \Pat(\all_1) \sqsubseteq \Pat(\all) $ }\\
{[\textit{CV-App}]}&\multicolumn{3}{l}{$ \ccestl {\appl {\lbt 1} {\lbt 2}}$ iff}\\
&&\multicolumn{2}{l}{$\ccest {\lbt 1} \wedge \ccest {\lbt 2} \wedge$} \\
&&\multicolumn{2}{l}{$\Pat(\all_1) \sqsubseteq \Pat(\all) \wedge \Pat(\all_2) \sqsubseteq \Pat(\all)$} \\
&&\multicolumn{2}{l}{$\forall (\lam{x}{\lbt 0}) \in \Cat(\all_1) :$}\\
&&&$\Cat(\all_2) \sqsubseteq \Env(x) \wedge \Cat(\all_0) \sqsubseteq \Cat(\all) \wedge$\\
&&&$\Pat(\all_0) \sqsubseteq \Pat(\all) $\\
{[\textit{CV-Seq}]}&\multicolumn{3}{l}{$ \ccestl {\lbt 1;\lbt 2} $ iff } \\ 
&&\multicolumn{2}{l}{$\ccest {\lbt 1} \wedge\Pat(\all_1) \sqsubseteq \Pat(\all) \wedge$} \\
&&\multicolumn{2}{l}{$\ccest {\lbt 2}\wedge \Pat(\all_2) \sqsubseteq \Pat(\all) \wedge$} \\
&&\multicolumn{2}{l}{$\Cat(\all_0) \sqsubseteq \Cat(\all)$} \\
{[\textit{CV-Op}]}&\multicolumn{3}{l}{$ \ccestl {\op (\vec{\lbt i})} $ iff}\\
&&\multicolumn{2}{l}{$\widehat{op} (\Cat(\all_i)) \sqsubseteq \Cat(\all) \wedge$}\\
&&\multicolumn{2}{l}{$\forall i : \ccest {\lbt i} \wedge \Pat(\all_i) \sqsubseteq \Pat(\all)  $}\\
{[\textit{CV-Cond}]}&\multicolumn{3}{l}{$\ccestl{\cond {\lbt 0} {\lbt 1} {\lbt 2}} $ iff}\\
&&\multicolumn{2}{l}{$ \ccest {\lbt 0} \wedge $}\\
&&\multicolumn{2}{l}{$\Pat(\all_0) \sqsubseteq \Pat(\all) \wedge$} \\
&&\multicolumn{2}{l}{$\widehat{\true} \in \Cat(\all_0) \Rightarrow$}\\
&&&$\ccest {\lbt 1} \wedge \Cat(\all_1) \sqsubseteq \Cat(\all)\wedge$\\
&&&$\Pat(\all_1) \sqsubseteq \Pat(\all) \wedge$ \\
&&\multicolumn{2}{l}{$\widehat{\false} \in \Cat(\all_0) \Rightarrow$}\\
&&&$\ccest {\lbt 2} \wedge \Cat(\all_2) \sqsubseteq \Cat(\all) \wedge$\\
&&&$\Pat(\all_2) \sqsubseteq \Pat(\all)$ \\
{[\textit{CV-While}]}&\multicolumn{3}{l}{$\ccestl {\while {\lbt 1} {\lbt 2}} $ iff}\\
&&\multicolumn{2}{l}{$ \ccest {\lbt 1} \wedge \Pat(\all_1) \sqsubseteq \Pat(\all) \wedge$}\\
&&\multicolumn{2}{l}{$\widehat{\true} \in \Cat(\all_1) \Rightarrow$}\\
&&&$\ccest {\lbt 2} \wedge \Pat(\all_2) \sqsubseteq \Pat(\all)\wedge$\\
&&\multicolumn{2}{l}{$\widehat{\false} \in \Cat(\all_1) \Rightarrow \widehat{\undef} \sqsubseteq \Cat(\all)$}\\
\end{tabular}
\caption{Compositional Verbose part 1}
\label{tab:CompVerb1}
\end{table}

\begin{table}[tlb]
\begin{tabular} {l l l l}
{[\textit{CV-GetField}]}&\multicolumn{3}{l}{$\ccestl {\lookup {\lbt 1} {\lbt 2}} $ iff}\\
&&\multicolumn{2}{l}{$ \ccest {\lbt1} \wedge \Pat(\all_1) \sqsubseteq \Pat(\all) \wedge$}\\
&&\multicolumn{2}{l}{$ \ccest {\lbt 2} \wedge \Pat(\all_2) \sqsubseteq \Pat(\all) \wedge$} \\
&&\multicolumn{2}{l}{$\widehat{get} (\Cat(\all_1), \Cat(\all_2)) \sqsubseteq \Cat(\all)$} \\
{[\textit{CV-SetField}]}&\multicolumn{3}{l}{$\ccestl {\store {\lbt 0} {\lbt 1} {\lbt 2}} $ iff}\\
&&\multicolumn{2}{l}{$ \ccest {\lbt 0} \wedge \Pat(\all_0) \sqsubseteq \Pat(\all) \wedge$}\\
&&\multicolumn{2}{l}{$ \ccest {\lbt 1} \wedge \Pat(\all_1) \sqsubseteq \Pat(\all) \wedge$} \\
&&\multicolumn{2}{l}{$ \ccest {\lbt 2} \wedge \Pat(\all_2) \sqsubseteq \Pat(\all) \wedge$} \\
&&\multicolumn{2}{l}{$\widehat{set} (\Cat(\all_0), \Cat(\all_1), \Cat(\all_2)) \sqsubseteq \Cat(\all)$} \\
{[\textit{CV-DelField}]}&\multicolumn{3}{l}{$\ccestl {\delete {\lbt 1} {\lbt 2}} $ iff}\\ 
&&\multicolumn{2}{l}{$ \ccest {\lbt 1} \wedge \Pat(\all_1) \sqsubseteq \Pat(\all) \wedge$}\\
&&\multicolumn{2}{l}{$ \ccest {\lbt 2} \wedge \Pat(\all_2) \sqsubseteq \Pat(\all) \wedge$} \\
&&\multicolumn{2}{l}{$\widehat{del} (\Cat(\all_1), \Cat(\all_2)) \sqsubseteq \Cat(\all)$}\\
{[\textit{CV-Ref}]}&\multicolumn{3}{l}{$ \ccestl {\newref {\ell} {\lbt 1}} $ iff}\\
&&\multicolumn{2}{l}{$\ccest {\lbt 1} \wedge \Pat(\all_1) \sqsubseteq \Pat(\all) \wedge$}\\
&&\multicolumn{2}{l}{$\ell \in \Cat(\all) \wedge \Cat(\all_1) \sqsubseteq \muat(\ell, \rho_s) $}\\
{[\textit{CV-DeRef}]}&\multicolumn{3}{l}{$\ccestl {\deref {\lbt 1}} $ iff}\\
&&\multicolumn{2}{l}{$ \ccest {\lbt 1}\wedge \Pat(\all_1) \sqsubseteq \Pat(\all) \wedge$}\\
&&\multicolumn{2}{l}{$\forall \ell \in \Cat(\all_1) :\muat(\ell, \rho_s) \sqsubseteq \Cat(\all)$} \\
{[\textit{CV-SetRef}]}&\multicolumn{3}{l}{$\ccestl {\setref {\lbt 1} {\lbt 2}} $ iff}\\
&&\multicolumn{2}{l}{$ \ccest {\lbt 1} \wedge \Pat(\all_1) \sqsubseteq \Pat(\all) \wedge $}\\
&&\multicolumn{2}{l}{$ \ccest {\lbt 2} \wedge \Pat(\all_2) \sqsubseteq \Pat(\all) \wedge $}\\
&&\multicolumn{2}{l}{$\Cat(\all_2) \sqsubseteq \Cat(\all) \wedge$} \\
&&\multicolumn{2}{l}{$ \forall \ell \in \Cat(\all_1) : \Cat(\all_2) \sqsubseteq \muat(\ell, \rho_s)$} \\
{[\textit{CV-Send}]}& \dots \\
{[\textit{CV-Exercise}]}&\multicolumn{3}{l}{$\ccestl {\exercise {\rho}} $ iff}\\
&&\multicolumn{2}{l}{$ \rho \sqsubseteq \rho_s \Rightarrow \rho \sqsubseteq \Pat(\all) \wedge $}\\
&&\multicolumn{2}{l}{$ \mathbf{unit} \in \Cat(\all)$}\\
\end{tabular}
\caption{Compositional Verbose part 2}
\label{tab:CompVerb2}
\end{table}

\section{Constraint generation}
\label{sec:ConstraintGen}
\newcommand{\genl}[1]{\mathcal{C}_{*\rho_s}\llbracket (#1)^\all \rrbracket}
\newcommand{\gen}[1]{\mathcal{C}_{*\rho_s}\llbracket (#1) \rrbracket}
\newcommand{\Cel}{\mathsf{C}}
\newcommand{\Rel}{\mathsf{\Gamma}}
\newcommand{\Pel}{\mathsf{P}}
\newcommand{\Mel}{\mathsf{M}}
\newcommand{\El}{\mathsf{E}}
\newcommand{\braces}[1]{\{ #1 \} }
\newcommand{\parens}[1]{\( #1 \) }

Constraint elements: $\El$.
\[
\begin{array}{llcl}
\mathit{Cache\ element} & \Cel(\ell)& : & \labs \rightarrow \absvalues \\
\mathit{Var\ element} & \Rel(x) & : & \vars \rightarrow \absvalues \\
\mathit{State\ element} & \Mel(\perms, ref) & : & \labs \times \perms \rightarrow \absvalues \\
\end{array}
\]

Permission Element: $\Pel(\ell) : \labs \rightarrow \perms $


Constraint form.
\[
\begin{array}{lrcl}
\mathit{Term\ inclusion} & \{\vat\} & \sqsubseteq & \El \\
\mathit{Element\ inclusion} & \El & \sqsubseteq & \El \\
\mathit{Permission\ inclusion} & \Pel(\ell) & \sqsubseteq & \Pel(\ell') \\
\mathit{Operation} & \widehat{Op}(\vec{\El_i}) & \sqsubseteq & \El \\
\mathit{Implication} & \{\vat\} \sqsubseteq \El & \Rightarrow & \El \sqsubseteq \El \\
%\mathit{Memory\ implication} & (\{r\} \sqsubseteq \El \wedge \rho_r \sqsubseteq \rho_s) & \Rightarrow & \El \sqsubseteq \El\\
\end{array}
\]
Misc:
\[
\begin{array}{l l}
r_* & $is the set of all references of the program;$\\
lambda_* & $is the set of all lambdas of the program;$\\
\end{array}
\]

\begin{table}
\begin{tabular}{l l l l}
{[\textit{CG-Val}]} & \multicolumn{3}{l}{$ \genl {v} = \vat \sqsubseteq \Cel(\all)$} \\ 
{[\textit{CG-Var}]} & \multicolumn{3}{l}{$ \genl {x} = \Rel(x) \sqsubseteq \Cel(\all)$} \\ 
{[\textit{CG-Lambda}]} & \multicolumn{3}{l}{$ \genl {\lam{x}{\lbt 0}} = $}\\
&& \multicolumn{2}{l}{$\{\{\lam{x}{\lbt 0}\} \sqsubseteq \Cel(\all)\}\cup $}\\
&& \multicolumn{2}{l}{$ \gen {\lbt 0} $} \\
%{[\textit{CG-Obj}]} & \multicolumn{3}{l}{$ \genl {\rec{\vec{str_i : \lbt i}}} = $}\\
%&& \multicolumn{2}{l}{$\bigcup_i (\gen {\lbt i} \cup$}\\
%&&& $\{\Pel(\all_i) \sqsubseteq \Pel(\all)\})\cup$\\ 
%&& \multicolumn{2}{l}{$\braces{\rec{\vec{str_i : \Cel(\all_i)}} \sqsubseteq \Cel(\all)} $} \\
{[\textit{CG-Let}]} & \multicolumn{3}{l}{$\genl {\letexpr{x_1}{\lbt 1}{{e'}^{\all'}}} = $}\\
&& \multicolumn{2}{l}{$ \gen {\lbt 1} \cup \gen {{e'}^{\all'}} \cup$ }\\
&& \multicolumn{2}{l}{$ \{\Cel(\all_1) \sqsubseteq \Rel(x_1)\} \cup \braces{\Pel(\all_1) \sqsubseteq \Pel(\all)}) \cup $} \\
&& \multicolumn{2}{l}{$ \{\Pel(\all') \sqsubseteq \Pel(\all)\} \cup \{\Cel(\all') \sqsubseteq \Cel(\all)\} $}\\
{[\textit{CG-App}]}&\multicolumn{3}{l}{$ \genl {\appl {\lbt 1} {\lbt 2}} = $}\\
&& \multicolumn{2}{l}{$\gen {\lbt 1} \cup \gen {\lbt 2} \cup$} \\
&& \multicolumn{2}{l}{$\braces{\Pel(\all_1) \sqsubseteq \Pel(\all)} \cup \braces{\Pel(\all_2) \sqsubseteq \Pel(\all)}\cup$} \\
&& \multicolumn{2}{l}{$\{\braces t \sqsubseteq \Cel(\all_1) \Rightarrow \Cel(\all_2) \sqsubseteq \Rel(x)$}\\
&&&$| t = (\lam {x} {\lbt 0}) \in lambda_* \}\cup$\\
&& \multicolumn{2}{l}{$\{\braces t \sqsubseteq \Cel(\all_1) \Rightarrow \Cel(\all_0) \sqsubseteq \Cel(\all)$}\\
&&&$| t = (\lam {x} {\lbt 0}) \in lambda_* \}\cup$\\
&& \multicolumn{2}{l}{$\{\braces t \sqsubseteq \Cel(\all_1) \Rightarrow \Pel(\all_0) \sqsubseteq \Pel(\all)$}\\
&&&$| t = (\lam {x} {\lbt 0}) \in lambda_* \}\cup$\\
{[\textit{CG-Op}]}&\multicolumn{3}{l}{$ \genl {\op (\vec{\lbt i})} = $}\\
&&\multicolumn{2}{l}{$\bigcup_i (\gen {\lbt i} \cup \braces{\Pel(\all_i) \sqsubseteq \Pel(\all)})\cup$}\\
&&\multicolumn{2}{l}{$\braces{\widehat{op} (\Cel(\all_i)) \sqsubseteq \Cel(\all)}$}\\
{[\textit{CG-Cond}]}&\multicolumn{3}{l}{$\genl{\cond {\lbt 0} {\lbt 1} {\lbt 2}} = $}\\
&&\multicolumn{2}{l}{$ \gen {\lbt 0} \cup \gen {\lbt 1} \cup \gen {\lbt 2} \cup$}\\
&&\multicolumn{2}{l}{$\braces{\Pat(\all_0) \sqsubseteq \Pat(\all)} \cup$} \\
&&\multicolumn{2}{l}{$\braces{\widehat{\true} \in \Cel(\all_0) \Rightarrow \Cel(\all_1) \sqsubseteq \Cel(\all)}\cup$}\\
&&\multicolumn{2}{l}{$\braces{\widehat{\true} \in \Cel(\all_0) \Rightarrow \Pel(\all_1) \sqsubseteq \Pel(\all)}\cup$} \\
&&\multicolumn{2}{l}{$\braces{\widehat{\false} \in \Cel(\all_0) \Rightarrow \Cel(\all_2) \sqsubseteq \Cel(\all)}\cup$}\\
&&\multicolumn{2}{l}{$\braces{\widehat{\false} \in \Cel(\all_0) \Rightarrow \Pel(\all_2) \sqsubseteq \Pel(\all)}$} \\
{[\textit{CG-While}]}&\multicolumn{3}{l}{$\genl {\while {\lbt 1} {\lbt 2}} = $}\\
&&\multicolumn{2}{l}{$ \gen {\lbt 1} \cup \gen {\lbt 2} \cup $}\\
&&\multicolumn{2}{l}{$\braces{\Pel(\all_1) \sqsubseteq \Pel(\all)} \cup$} \\
%&&\multicolumn{2}{l}{$\braces{\true \in \Cel(\all_1) \Rightarrow \Cel(\all_2) \sqsubseteq \Cel(\all) }\cup$}\\
&&\multicolumn{2}{l}{$\braces{\true \in \Cel(\all_1) \Rightarrow \Pel(\all_2) \sqsubseteq \Pel(\all) }\cup$}\\
&&\multicolumn{2}{l}{$\braces{\false \in \Cel(\all_1) \Rightarrow \widehat{\undef} \sqsubseteq \Cel(\all)}$}\\
\end{tabular}
\caption{Constraint generation part 1}
\label{tab:ConstGen1}
\end{table}

\begin{table}[hbt]
\begin{tabular} {l l l l}
{[\textit{CG-GetField}]}&\multicolumn{3}{l}{$\genl {\lookup {\lbt 1} {\lbt 2}} = $}\\
&&\multicolumn{2}{l}{$ \gen {\lbt1} \cup \gen {\lbt 2} \cup$}\\
&&\multicolumn{2}{l}{$\braces{\Pel(\all_1) \sqsubseteq \Pel(\all)} \cup \braces{\Pel(\all_2) \sqsubseteq \Pel(\all)} \cup$} \\
&&\multicolumn{2}{l}{$\widehat{get} (\Cel(\all_1), \Cel(\all_2)) \sqsubseteq \Cel(\all)$} \\
{[\textit{CG-SetField}]}&\multicolumn{3}{l}{$\gen {\store {\lbt 0} {\lbt 1} {\lbt 2}} = $}\\
&&\multicolumn{2}{l}{$ \gen {\lbt 0} \cup \genl {\lbt 1} \cup \gen {\lbt 2} \cup $}\\
&&\multicolumn{2}{l}{$\braces{\Pel(\all_1) \sqsubseteq \Pel(\all)} \cup\braces{\Pel(\all_2) \sqsubseteq \Pel(\all)} \cup\braces{\Pel(\all_3) \sqsubseteq \Pel(\all)} \cup$} \\
&&\multicolumn{2}{l}{$\widehat{set} (\Cel(\all_1), \Cel(\all_2), \Cel(\all_2)) \sqsubseteq \Cel(\all)$} \\
{[\textit{CG-DelField}]}&\multicolumn{3}{l}{$\genl {\delete {\lbt 1} {\lbt 2}} = $}\\ 
&&\multicolumn{2}{l}{$ \gen {\lbt1} \cup \gen {\lbt 2} \cup$}\\
&&\multicolumn{2}{l}{$\braces{\Pel(\all_1) \sqsubseteq \Pel(\all)} \cup \braces{\Pel(\all_2) \sqsubseteq \Pel(\all)} \cup$} \\
&&\multicolumn{2}{l}{$\widehat{del} (\Cel(\all_1), \Cel(\all_2)) \sqsubseteq \Cel(\all)$}\\
{[\textit{CG-Ref}]}&\multicolumn{3}{l}{$ \genl {\newref {\ell} {\lbt 1}} = $}\\
&&\multicolumn{2}{l}{$\gen {\lbt 1} \cup\braces{\Pel(\all_1) \sqsubseteq \Pel(\all)} \cup$}\\
&&\multicolumn{2}{l}{$\braces{\Cel(\all_1) \sqsubseteq \Mel(\ell, \rho_s)} \cup \braces{\{\ell\} \sqsubseteq \Cel(\all)}$}\\
{[\textit{CG-DeRef}]}&\multicolumn{3}{l}{$\genl {\deref {\lbt 1}} = $}\\
&&\multicolumn{2}{l}{$ \gen {\lbt 1} \cup\braces{\Pel(\all_1) \sqsubseteq \Pel(\all)} \cup$}\\
&&\multicolumn{2}{l}{$\{\ell \in \Cel(\all_1) \Rightarrow \Mel(\ell, \rho_s) \sqsubseteq \Cel(\all)$} \\
&&&$|\ \ell \in Ref_*\}$\\
{[\textit{CG-SetRef}]}&\multicolumn{3}{l}{$\genl {\setref {\lbt 1} {\lbt 2}} = $}\\
&&\multicolumn{2}{l}{$ \gen {\lbt 1} \cup \gen {\lbt 2} \cup $}\\
&&\multicolumn{2}{l}{$ \braces{\Pel(\all_1) \sqsubseteq \Pel(\all)} \cup \braces{\Pel(\all_2) \sqsubseteq \Pel(\all)} \cup $}\\
&&\multicolumn{2}{l}{$\{\ell \in \Cel(\all_1) \Rightarrow \Cel(\all_2) \sqsubseteq \Mel(\ell, \rho_s)$}\\
&&&$|\ \ell \in Ref_*\}\cup$ \\
&&\multicolumn{2}{l}{$\braces{\Cel(\all_2) \sqsubseteq \Cel(\all)}$} \\
{[\textit{CG-Send}]}& \dots \\
{[\textit{CG-Exercise}]}& \multicolumn{3}{l}{$\genl {\exercise {\rho}} $}\\
&&\multicolumn{2}{l}{$ \braces {\rho \sqsubseteq \rho_s \Rightarrow \rho \sqsubseteq \Pel(\all)} \cup $}\\
&&\multicolumn{2}{l}{$ \mathbf{unit} \in \Cel(\all)$}\\
\end{tabular}
\caption{Constraint generation part 2}
\label{tab:ConstGen2}
\end{table}

\section{Constraint solving}
\label{sec:ConstraintSolving}

\begin{table}[htb]
\small
\begin{center}
\begin{tabular}{l l l}
INPUT: & $C_*[e_*]$\\
OUTPUT: & $(cat, ro)$\\
METHOD: &
Step 1:& Initialization\\
&&
\begin{lstlisting}[mathescape]
W := [] : Queue(CElem)
D := [] : Map(CElem -> $\hat{V}$)
E := [] : Map(CElem -> Constraint)
for a in cache do 
    Add (C a, $\bot$) D
    Add (C a, []) E
for x in vars do 
    Add (R x, $\bot$) D
    Add (R x, []) E
for r in refs do 
    Add (Mu ($\bot$, $\ell$), $\bot$) D
    Add (Mu ($\bot$, $\ell$), []) E
\end{lstlisting}\\
&Step 2: & Building the graph\\
&&
\begin{lstlisting}[mathescape]
for cc in lst do
    case cc of
    | {t} $\sqsubseteq$ p  -> 
      propagate p {t}
    | p1  $\sqsubseteq$ p2 -> 
      Add cc E[p1]
    | {t} $\sqsubseteq$ p $\Rightarrow$ p1 $\sqsubseteq$ p2 -> 
      Add cc E[p]
      Add cc E[p1]
    | {t} $\sqsubseteq$ p $\Rightarrow$ {t1} $\sqsubseteq$ p2 -> 
      Add cc E[p]
    | $\widehat{op}(\vec{ps}) \sqsubseteq$ p1  -> 
      for p in ps do
        Add cc E[p]
    | $\widehat{Get}$(p1, p2) $\sqsubseteq$ p3 -> 
      Add cc E[p1]
      Add cc E[p2]
    | $\widehat{Del}$(p1, p2) $\sqsubseteq$ p3 -> 
      Add cc E[p1]
      Add cc E[p2]
    | $\widehat{Set}$(p1, p2, p3) $\sqsubseteq$ p4 -> 
      Add cc E[p1]
      Add cc E[p2]
      Add cc E[p3]
\end{lstlisting}\\
\end{tabular}
\end{center}
\caption{Worklist Algorithm part 1.}
\label{tab:Worklist1}
\end{table}
\begin{table}[htb]
\small
\begin{center}
\begin{tabular}{l l l}
&Step 3: & Iteration\\
&&
\begin{lstlisting}[mathescape]
while W $\neq$ [] do
    q = dequeue W
    for cc in E[q] do
        case cc of
        | p1  $\sqsubseteq$ p2 -> 
            propagate p2 D[p1]
        | {t} $\sqsubseteq$ p $\Rightarrow$ p1 $\sqsubseteq$ p2 -> 
            if t $\in$ D[p] then
                propagate p2 D[p1]
        | {t} $\sqsubseteq$ p $\Rightarrow$ {t1} $\sqsubseteq$ p2 ->
            if t $\in$ D[p] then
                propagate p2 {t1}
        | $\widehat{op}(\vec{ps}) \sqsubseteq$ p1  -> 
            args = [D[p] | p $\in \vec{ps}$]
            res = $\widehat{op}$ args
            propagate p1 res
        | $\widehat{Get}$(p1, p2) $\sqsubseteq$ p3 -> 
            propagate p3 
                [D[C $\alpha$] | $\alpha \in \widehat{Get}$ (D[p1], D[p2])]
        | $\widehat{Del}$(p1, p2) $\sqsubseteq$ p3 -> 
            propagate p3 $\widehat{Del}$ (D[p1], D[p2]) 
        | $\widehat{Set}$(p1, p2, p3) $\sqsubseteq$ p4 -> 
            propagate p4 $\widehat{Set}$ (D[p1], D[p2]. D[p3]) 
\end{lstlisting}\\
& Step 4: & Recording the solution\\
&&
\begin{lstlisting}[mathescape]
for $\ell$ in $Ref_*$ do $\hat{\mu}(\ell)$ = D[Mu $\ell$]
for x in $Var_*$ do $\hat{\Gamma}(x)$ = D[R x]
for $\alpha$ in $Cache_*$ do $\hat{C}(\alpha)$ = D[C $\alpha$]
\end{lstlisting}\\
USING: \\
&&
\begin{lstlisting}[mathescape]
propagate q d =
    if d $\not\sqsubseteq$ D[q] then
        D[q] = D[q] $\join$ d
        Enqueue q W
    
\end{lstlisting}\\
\end{tabular}
\end{center}
\caption{Worklist Algorithm part 2.}
\label{tab:Worklist2}
\end{table}

\section{Abstract domains choice} % scelta dei domini astratti
\label{sec:AbstractDomChoice}

$ R_1=\rec{\vec{\widehat{str_i}:\widehat{v_i}}} \sqsubseteq \rec{\vec{\widehat{str_j}:\widehat{v_j}}}=R_2 $ sse:
\begin{enumerate}
\item $R_1$ ha meno campi di $R_2$
\item ogni campo di $R_1$ e' piu' preciso del \textbf{corrispondente} campo di $R_2$ 
\end{enumerate}

$\forall i, \exists j: \widehat{str_i} \sqsubseteq \widehat{str_j}$\\
$\forall i, \exists j: \widehat{str_i} \sqsubseteq \widehat{str_j} \Rightarrow \widehat{v_i} \sqsubseteq \widehat{v_j}$

Set:
\begin{itemize}
\item Exact
	\begin{itemize}
	\item $\exists \rightarrow Union$
	\item $\nexists \rightarrow add in prefix$
	\end{itemize}
\item Prefix
	\begin{itemize}
	\item aggiungo in $*$
	\end{itemize}
\end{itemize}

$\vat \sqsubseteq \vat'$ iff $\forall \widehat{u}_i \in \vat, \exists \widehat{u}_j \in \vat': \widehat{u}_i \sqsubseteq \widehat{u}_j $.\\
If Galois connection then \\
$\vat \sqsubseteq \vat'$ iff $\gamma(\vat) \subseteq \gamma(\vat') $\\
where $\gamma : \widehat{V} \rightarrow P(V)$ is the concretisation function.\\
$\gamma_p : \widehat{PV} \rightarrow P(V)$\\
$\gamma(\vat) = \bigcup_{\widehat{u}_i \in \vat} \gamma_p(\widehat{u}_i)$\\
\newpage
$
\begin{array}{ll}
\widehat{pre_{bool}} = \widehat{true} | \widehat{false}\\
\widehat{u_{bool}} = \{\vec{\widehat{pre_{bool}}}\}&$ with $\sqsubseteq = \subseteq\\
\widehat{pre_{int}} = \oplus | 0 | \ominus\\
\widehat{u_{int}} = \{\vec{\widehat{pre_{int}}}\}&$ with $\sqsubseteq = \subseteq\\
\widehat{pre_{string}} = s | s*\\
\widehat{u_{string}} = \{\vec{\widehat{pre_{string}}}\}&$ with $\sqsubseteq = \subseteq\\
&$ --- Giulia's spec. is more tricky than $\subseteq\\
\widehat{pre_{ref}} = r\\
\widehat{u_{ref}} = \{\vec{\widehat{pre_{ref}}}\}&$ with $\sqsubseteq = \subseteq\\
\widehat{pre_\lambda} = \lambda\\
\widehat{u_\lambda} = \{\vec{\widehat{pre_\lambda}}\}&$ with $\sqsubseteq = \subseteq\\
\widehat{pre_{rec}} = \rec{\vec{\widehat{str}_i: \vat_i}}\\
\widehat{u_{rec}} = \widehat{pre_{rec}}&$ with $ \sqsubseteq = \widehat{u_{rec}}_\sqsubseteq\\
\vat = (\widehat{u_{bool}}, \widehat{u_{int}}, \widehat{u_{string}}, \widehat{u_{ref}}, \widehat{u_{\lambda}}, \widehat{u_{rec}}, \{\widehat{Null}\}, \{\widehat{Undef}\})\\
&$ with $ \vat \sqsubseteq \vat' $ iff $ \\
&\widehat{u_{bool}} \sqsubseteq \widehat{u_{bool}}' \wedge\\
&\widehat{u_{int}} \sqsubseteq \widehat{u_{int}}' \wedge\\
&\widehat{u_{string}} \sqsubseteq \widehat{u_{string}}' \wedge\\
&\widehat{u_{ref}} \sqsubseteq \widehat{u_{ref}}' \wedge\\
&\widehat{u_{\lambda}} \sqsubseteq \widehat{u_{\lambda}}' \wedge\\
&\widehat{u_{rec}} \sqsubseteq \widehat{u_{rec}}' \wedge\\
&\widehat{Null} \not\in \vat' \vee \widehat{Null} \in \vat \wedge \widehat{Null} \in \vat' \wedge\\
&\widehat{Undef} \not\in \vat' \vee \widehat{Undef} \in \vat \wedge \widehat{Undef} \in \vat'\\
\end{array}
$


\section{Abstract operations} %- specifica delle operazioni astratte
\label{sec:AbstractOp}

\section{Requirements verification} % verifica delle condizioni (anche semi-formale)
\label{sec:RequirementVerif}

\section{Implementation-specific details}
\label{sec:ImplSpecDetails}